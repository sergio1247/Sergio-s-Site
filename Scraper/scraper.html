<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course List Manager</title>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <style>
        body {
            background-color: #222;
            color: #eee;
        }
        .title {
            display: flex;
            justify-content: center;
            margin-top: 0;
            margin-bottom: 0;
            padding: 0%;
        }
        .title h1{
            font-size: 25px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 90%vh;
            padding: 15px;
        }

        .load-section {
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 15px;
        }
        .message-box {
            display: flex;
            justify-content: center;
            background-color: #333;
            align-items: center;
            text-align: center;
            width: 60%;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .list-columns {
            display: flex;
            justify-content: center; /* Center the columns horizontally */
            gap: 20px; /* Add gap between columns */
            width: 100%;
            height: 100%; /* Ensure it fills the remaining space */
        }

        .column-container {
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent overflow */
        }

        .left-column {
            width: 60%; /* Set the width for the left column */
            padding: 20px;
            background-color: #333;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .right-column {
            width: 40%; /* Set the width for the right column */
            padding: 20px;
            background-color: #333;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .left-column h2,
        .right-column h2 {
            margin-top: 0;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .button-group {
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .button-group button {
            margin-right: 10px; /* Add margin between buttons */
        }

        .button-group button:last-child {
            margin-right: 0; /* Remove margin for the last button */
        }

        .text-padding {
            overflow-x: hidden;
            margin-top: 5px;
        }

        .output-area {
            flex: 1; /* Allow the output area to take up remaining space */
            width: 100%;
            padding: 5px;
            border-radius: 8px;
            font-size: 13px;
            overflow-x: auto; /* Enable horizontal scrolling */
            overflow-y: auto; /* Enable vertical scrolling */
            white-space: nowrap; /* Prevent line breaks */
        }

        button {
            background-color: #555;
            color: #eee;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #777;
        }

        input[type="text"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #777;
            background-color: #333;
            color: #eee;
        }
    </style>
</head>

<body>
    <div class="title">
        <h1>Course List Manager</h1>
    </div>
    
    <div class="container">
        <div class="load-section">
            <div class="input-group">
                <button id="load-fall24" value="https://web.csulb.edu/depts/enrollment/registration/class_schedule/Fall_2024/By_College/CECS.html">Fall 2024 CECS Courses</button>
                <button id="load-spring24" value="https://web.csulb.edu/depts/enrollment/registration/class_schedule/Spring_2024/By_Subject/CECS.html">Spring 2024 CECS Courses</button>
                <input id="url-input" type="text" placeholder="Enter URL for course list" value="">
                <button id="load-courses">Load URL</button>
                <button id="index">CSULB Website</button>
            </div>
        </div>
        <div class="message-box" id="message">
            Pick a list of classes from above or paste your own URL from the CSULB website
        </div>
        <div class="list-columns">
            <div class="column-container left-column">
                <h2>Course Search List</h2>
                <div class="input-group">
                    <input id="course-code-input" type="text" placeholder="Enter Course Code to Filter">
                    <button id="filter-code">Filter by Code</button>
                </div>
                <div class="button-group">
                    <button id="show-open">Show Open Courses</button>
                    <button id="show-all">Show All Courses</button>
                    <button id="revert">Revert to Original List</button>
                </div>
                <div class="text-padding">
                    <div class="output-area" id="course-list"></div>
                </div>
            </div>
            <div class="column-container right-column">
                <h2>Wishlist</h2>
                <div class="input-group">
                    <input id="course-num-input" type="text" placeholder="Enter Course Number to Add" value="8078">
                    <button id="add-course">Add Course</button>
                </div>
                <div class="button-group">
                    <button id="show-wishlist">Show Wish List</button>
                    <button id="generate-schedules">Generate Schedules</button>
                </div>
                <div class="text-padding">
                    <div class="output-area" id="wish-list"></div>
                </div>
            </div>
        </div>
    </div>

    <py-script>
        import asyncio
        import micropip
        import webbrowser
        from pyodide.http import pyfetch
        from datetime import datetime
    
        async def setup():
            await micropip.install("beautifulsoup4")
            global BeautifulSoup
            from bs4 import BeautifulSoup
    
            global courses, original_courses, wishlist
    
            courses = []
            original_courses = []
            wishlist = []
            #Element('message').element.innerHTML = "Pick a list of classes from above or paste your own URL from the CSULB website"
    
            class Course:
                def __init__(self, code="", num="", name="", sec="", units="", type="", days=[], time="", open=True,
                             startTime="", endTime="", loc="", inst=""):
                    self.code = code
                    self.num = num
                    self.name = name
                    self.sec = sec
                    self.units = units
                    self.type = type
                    self.days = days
                    self.time = time
                    self.open = open
                    self.startTime = startTime
                    self.endTime = endTime
                    self.loc = loc
                    self.inst = inst
    
                def setSec(self, sec):
                    self.sec = sec
    
                def setCode(self, code):
                    self.code = code
    
                def setName(self, name):
                    self.name = name
    
                def setUnits(self, units):
                    self.units = units
    
                def setNum(self, num):
                    self.num = num
    
                def setType(self, type):
                    self.type = type
    
                def setDays(self, days):
                    self.days = days
    
                def setTime(self, time):
                    self.time = time
                    self.setMillTimes(time)
    
                def setMillTimes(self, time):
                    if time == "NA":
                        self.startTime = time
                        self.endTime = time
                    else:
                        for i, char in enumerate(time):
                            if time[i+1] == '-':
                                begin = time[:i+1]
                                end = time[i+2:]
                                hr1, hr2 = '', ''
                                for char in begin:
                                    if char == ':':
                                        break
                                    hr1 += char
                                for char in end:
                                    if char == ':':
                                        break
                                    hr2 += char
                                hr1, hr2 = int(hr1), int(hr2)
                                if hr2 == 12:
                                    begin += "AM"
                                elif time[-2:] == "AM":
                                    begin += "AM"
                                else:
                                    begin += "PM"
                                break
    
                        def milTime(time_str):
                            try:
                                return datetime.strptime(time_str, "%I:%M%p").strftime("%H:%M")
                            except ValueError:
                                pass
                            try:
                                return datetime.strptime(time_str, "%I%p").strftime("%H:%M")
                            except ValueError:
                                pass
                            raise ValueError(f"Time format error: '{time_str}' does not match any recognized format.")
    
                        self.startTime = milTime(begin)
                        self.endTime = milTime(end)
    
                def closed(self):
                    self.open = False
    
                def isOpen(self):
                    return self.open
    
                def setLoc(self, loc):
                    self.loc = loc
    
                def setInst(self, inst):
                    self.inst = inst
    
                def getCodeNum(self):
                    s = self.code
                    digits = ""
                    for char in s:
                        if char.isdigit():
                            digits = s[s.index(char):]
                            break
                    if digits[-1:] == "H":
                        digits = digits[:-1]
                    return digits

                def getNum(self):
                    return self.num
    
                def __repr__(self):
                    status = "OPEN" if self.open else "CLOSED"
                    return (f"{self.code} -- '{self.name}', Class# {self.num}, section {self.sec}, {self.units}, {self.type}, "
                            f"{''.join(self.days)}, {self.time}, {status}, {self.loc}, {self.inst}")
    
            def daysExtractor(s):
                if s in ["NA", "TBA"]:
                    return [s]
                days = []
                for day in ["M", "Tu", "W", "Th", "F", "Sa", "Su"]:
                    if day in s:
                        days.append(day)
                return days
    
            def printList(lst, element_id):
                course_list_element = Element(element_id)
                course_list_html = "<br>".join(f"{i+1}. {str(course)}" for i, course in enumerate(lst))
                course_list_element.element.innerHTML = course_list_html
                #print(f"Updated {element_id} with course list: {course_list_html}")
    
            async def scrapeSite(url):
                response = await pyfetch(url)
                text = await response.string()
                soup = BeautifulSoup(text, "html.parser")
                allClasses = soup.find_all(class_="courseBlock")
    
                courses = []
    
                for course_html in allClasses:
                    header = course_html.find(class_="courseHeader")
                    table = course_html.find(class_="sectionTable")
                    if header:
                        code = header.find("span", class_="courseCode").text.strip()
                        title = header.find("span", "courseTitle").text.strip()
                        units = header.find("span", "units").text.strip()
    
                    if table:
                        rows = table.find_all("tr")
                        for row in rows[1:]:
                            temp = Course()  # Create a new Course object for each row
                            data = row.find_all("td")
                            temp.setSec(row.find_all("th")[0].text)
                            temp.setCode(code)
                            temp.setName(title)
                            temp.setUnits(units)
                            temp.setNum(data[0].text)
                            temp.setType(data[4].text)
                            temp.setDays(daysExtractor(data[5].text))
                            temp.setTime(data[6].text)
                            temp.setLoc(data[8].text)
                            temp.setInst(data[9].text)
                            if row.find(title="Seats available") is None:
                                temp.closed()
                            courses.append(temp)
    
                return courses
    
            async def fetch_and_display_courses(url, event=None):
                global courses, original_courses
                courses = await scrapeSite(url)
                if not courses:
                    Element('message').element.innerHTML = "No courses articulated, please try a different link"
                    return
                original_courses = courses.copy()
                course = courses[0]
                courseCode = course.code.split()[0]
                printList(courses, 'course-list')
                Element('message').element.innerHTML = f"Displaying courses for {courseCode}"
                #print("Courses fetched and displayed")

            def openSite(event=None):
                index = "https://web.csulb.edu/depts/enrollment/registration/class_schedule/Fall_2024/By_College/index.html"
                webbrowser.open(index)

            def show_wishlist(event=None):
                #print("Showing Print List...")
                printList(wishlist, 'wish-list')
    
            def filter_by_code(event=None):
                #print("Filtering by code...")
                code = Element('course-code-input').element.value.strip()
                filtered_courses = [course for course in courses if code.lower() in course.getCodeNum().lower()]
                printList(filtered_courses, 'course-list')
                #print("Filtered courses displayed")
    
            def show_open_courses(event=None):
                #print("Showing open courses...")
                open_courses = [course for course in courses if course.isOpen()]
                printList(open_courses, 'course-list')
                if courses:
                    Element('message').element.innerHTML = "Showing only open courses"
                else:
                    Element('message').element.innerHTML = "No courses in list"
                #print("Open courses displayed")
    
            def show_all_courses(event=None):
                #print("Showing all courses...")
                printList(courses, 'course-list')
                #print("All courses displayed")
    
            def revert_to_original(event=None):
                #print("Reverting to original list...")
                global courses, original_courses
                courses = original_courses.copy()
                printList(courses, 'course-list')
                #print("Reverted to original list")
    
            def add_course(event=None):
                #print("Adding course...")
                global wishlist
                pick = Element('course-num-input').element.value.strip()
                if any(course.getNum() == pick for course in wishlist):
                    Element('message').element.innerHTML = "Course is already in the schedule."
                    #print("Course already in wishlist")
                    return
                for course in courses:
                    if course.getNum() == pick:
                        wishlist.append(course)
                        Element('message').element.innerHTML = f"Course {course.getCodeNum()} added to the schedule."
                        #print(f"Course {course.getNum()} added to wishlist")
                        printList(wishlist, 'wish-list')
                        return
                Element('message').element.innerHTML = "Course not found."
                #print("Course not found. Element =" ,pick)
    
            def generate_schedules(event=None):
                #print("Generating schedules...")
                global wishlist
                original = wishlist
                schedulesFinal = []
                count = 1
    
                def backtrack(currentSchedule, index):
                    nonlocal count
                    if index == len(original):
                        if currentSchedule not in schedulesFinal and len(currentSchedule) == 4:
                            schedulesFinal.append(currentSchedule.copy())
                            schedule_html = f"<br>--- Schedule {count} ---<br>" + "<br>".join(str(course) for course in currentSchedule)
                            Element('schedule-list').element.innerHTML += schedule_html
                            count += 1
                        return
    
                    course = original[index]
                    can_add = True
                    for classInSchedule in currentSchedule:
                        if classInSchedule.getCodeNum() == course.getCodeNum() or \
                           (set(classInSchedule.getDays()) & set(course.getDays()) and
                            classInSchedule.getStartTime() < course.getEndTime() and
                            classInSchedule.getEndTime() > course.getStartTime()):
                            can_add = False
                            break
    
                    if can_add:
                        currentSchedule.append(course)
                        backtrack(currentSchedule, index + 1)
                        currentSchedule.pop()
    
                    backtrack(currentSchedule, index + 1)
    
                backtrack([], 0)
                #print("Schedules generated")
                printList(wishlist, 'schedule-list')
    
            Element("load-fall24").element.onclick = lambda event: fetch_and_display_courses("https://web.csulb.edu/depts/enrollment/registration/class_schedule/Fall_2024/By_College/CECS.html", event)
            Element("load-spring24").element.onclick = lambda event: fetch_and_display_courses("https://web.csulb.edu/depts/enrollment/registration/class_schedule/Spring_2024/By_Subject/CECS.html", event)
            Element("load-courses").element.onclick = lambda event: fetch_and_display_courses(Element("url-input").element.value, event)
            Element("filter-code").element.onclick = filter_by_code
            Element("add-course").element.onclick = add_course
            Element("show-open").element.onclick = show_open_courses
            Element("show-wishlist").element.onclick = show_wishlist
            Element("show-all").element.onclick = show_all_courses
            Element("revert").element.onclick = revert_to_original
            Element("generate-schedules").element.onclick = generate_schedules
            Element("index").element.onclick = openSite
    
        asyncio.ensure_future(setup())
    </py-script>
</body>
</html>
